<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taxi Cost Calculator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&display=swap');
        
        :root {
            --matrix-green: #00ff41;
            --matrix-dark: #0d0208;
            --taxi-yellow: #ffd700;
            --neon-glow: 0 0 5px var(--matrix-green);
            --font-size: 16px;
            --font-size-large: 18px;
            --font-size-xlarge: 22px;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Ubuntu Mono', monospace;
            background-color: var(--matrix-dark);
            color: var(--matrix-green);
            margin: 0;
            padding: 10px;
            line-height: 1.4;
            text-shadow: 0 0 3px rgba(0, 255, 65, 0.3);
            font-size: var(--font-size);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            display: none;
        }
        
        .auth-container {
            text-align: center;
            margin: auto;
            padding: 20px;
            max-width: 300px;
        }
        
        h1 {
            text-align: center;
            font-size: var(--font-size-xlarge);
            margin: 10px 0;
            color: var(--taxi-yellow);
            text-shadow: var(--neon-glow);
        }
        
        /* Остальные стили остаются без изменений */
        /* ... */
        
    </style>
</head>
<body>
    <div class="auth-container" id="auth-section">
        <h1>Taxi Cost Calculator</h1>
        <div id="auth-button">
            <button onclick="loginWithTelegram()">Войти через Telegram</button>
            <div style="margin-top: 10px;">
                <input type="checkbox" id="remember-me" checked>
                <label for="remember-me">Запомнить меня</label>
            </div>
        </div>
    </div>

    <div class="container" id="app-content">
        <!-- Контент приложения остается без изменений -->
        <!-- ... -->
    </div>

    <script>
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            // Проверяем, находимся ли мы в Telegram WebApp
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                // Подписываемся на события
                Telegram.WebApp.onEvent('themeChanged', updateTheme);
                Telegram.WebApp.onEvent('viewportChanged', checkAuth);
                
                updateTheme();
                checkAuth();
            } else {
                initializeAuth();
            }
        });

        function updateTheme() {
            if (window.Telegram?.WebApp) {
                const theme = Telegram.WebApp.colorScheme;
                document.body.style.backgroundColor = theme === 'dark' ? '#0d0208' : '#f0f0f0';
            }
        }

        function checkAuth() {
            if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                handleTelegramAuth();
            } else {
                checkSavedSession();
            }
        }

        // ==================== АВТОРИЗАЦИЯ ====================
        function handleTelegramAuth() {
            const tg = Telegram.WebApp;
            const user = tg.initDataUnsafe.user;
            
            const sessionData = {
                user: {
                    id: user.id,
                    first_name: user.first_name,
                    last_name: user.last_name,
                    username: user.username
                },
                isWebApp: true,
                authDate: tg.initDataUnsafe.auth_date
            };
            
            localStorage.setItem('tg_auth', JSON.stringify(sessionData));
            showAppContent(user.first_name || 'Пользователь');
            loadLastCalculation();
        }

        function checkSavedSession() {
            const savedAuth = localStorage.getItem('tg_auth');
            if (!savedAuth) {
                showAuthButton();
                return;
            }

            const session = JSON.parse(savedAuth);
            const sessionExpired = session.authDate && 
                (Date.now() / 1000 - session.authDate) > 30 * 24 * 60 * 60;
            
            if (!sessionExpired) {
                showAppContent(session.user.first_name || 'Пользователь');
                loadLastCalculation();
            } else {
                localStorage.removeItem('tg_auth');
                showAuthButton();
            }
        }

        function loginWithTelegram() {
            const botId = "7474644739"; // Ваш корректный ID бота
            const origin = encodeURIComponent(window.location.origin);
            const authUrl = `https://oauth.telegram.org/auth?bot_id=${botId}&origin=${origin}&request_access=write`;
            
            if (window.Telegram?.WebApp?.platform !== "unknown") {
                // Внутри Telegram
                Telegram.WebApp.openTelegramLink(authUrl);
                
                // Добавляем обработчик сообщений
                window.addEventListener('message', (event) => {
                    if (event.origin !== 'https://oauth.telegram.org') return;
                    
                    if (event.data?.event === 'auth_result' && event.data?.result === 'success') {
                        handleAuthSuccess(event.data.user);
                    }
                });
            } else {
                // В браузере
                const authWindow = window.open(authUrl, 'TelegramAuth', 'width=500,height=600');
                
                window.addEventListener('message', (event) => {
                    if (event.origin !== 'https://oauth.telegram.org') return;
                    
                    if (event.data?.event === 'auth_result' && event.data?.result === 'success') {
                        handleAuthSuccess(event.data.user);
                        if (authWindow) authWindow.close();
                    }
                });
            }
        }

        function handleAuthSuccess(user) {
            if (document.getElementById('remember-me').checked) {
                const sessionData = {
                    user: user,
                    isWebApp: false,
                    authDate: Math.floor(Date.now() / 1000)
                };
                localStorage.setItem('tg_auth', JSON.stringify(sessionData));
            }
            
            showAppContent(user.first_name || 'Пользователь');
            loadLastCalculation();
        }

        function showAppContent(username) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('username').textContent = username;
        }

        function showAuthButton() {
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('app-content').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('tg_auth');
            localStorage.removeItem('last_calculation');
            showAuthButton();
        }

        // ==================== КАЛЬКУЛЯТОР ====================
        // Функции калькулятора остаются без изменений
        // ... 

    </script>
</body>
</html>
